<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NESO - 龍門射門 (管理端)</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
</head>

<body>
    <div class="app-container">
        <!-- Left: Game Stage (OBS) -->
        <main class="game-stage">
            <div class="streamer-info">
                <div class="pool-display">
                    <span class="label">獎金池 JACKPOT</span>
                    <div class="value-container">
                        <img src="assets/coin.png" class="coin-icon" alt="Coin">
                        <span class="value" id="poolAmount">0</span>
                    </div>
                    <span class="unit">NESO</span>
                </div>
            </div>

            <div class="Table">
                <div class="cards-area">
                    <div class="card" id="card1">
                        <div class="card-inner">
                            <div class="card-front">?</div>
                            <div class="card-back"></div>
                        </div>
                    </div>
                    <div class="card" id="card3">
                        <div class="card-inner">
                            <div class="card-front mystery">?</div>
                            <div class="card-back"></div>
                        </div>
                    </div>
                    <div class="card" id="card2">
                        <div class="card-inner">
                            <div class="card-front">?</div>
                            <div class="card-back"></div>
                        </div>
                    </div>
                </div>

                <div class="game-status-container">
                    <div class="odds-display hidden" id="oddsDisplay">賠率: <span id="currentOdds">0</span>x</div>
                    <div class="game-status" id="gameStatus">等待開始</div>
                </div>

                <div class="current-player hidden" id="currentPlayerDisplay">
                    <div class="player-avatar">😎</div>
                    <div class="player-details">
                        <div class="player-label">當前挑戰者</div>
                        <div class="player-address" id="playerAddress">0x...</div>
                        <div class="player-bet">
                            <span class="label">下注:</span>
                            <span class="amount" id="playerBetAmount">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Game Controls -->
            <div class="controls-overlay hidden" id="gameControls">
                <button class="btn-action giant-btn" id="btnReveal" onclick="game.revealCard3()">🔥 射門! 🔥</button>
                <div class="result-actions hidden" id="resultActions">
                    <button class="btn-payout" id="btnPayout" onclick="game.generatePayout()">🏆 複製中獎資訊</button>
                    <button class="btn-replay" onclick="game.openReplayModal()">🔄 再來一局</button>
                    <button class="btn-next" onclick="game.nextRound()">下一局 ⏭️</button>
                </div>
            </div>
        </main>

        <!-- Right: Control Panel -->
        <aside class="dashboard-sidebar">
            <div class="sidebar-header">
                <h2>🎛️ 控制面板</h2>
            </div>

            <div class="panel-card action-section">
                <!-- Using onclick="ui.openAddModal()" ensuring ui is loaded -->
                <button class="btn-primary-pop" id="btnAddPlayer" onclick="ui.openAddModal()">
                    <span class="icon">➕</span>
                    <span class="text">新增挑戰者</span>
                </button>
                <button class="btn-secondary-pop" id="btnImport" onclick="ui.openImportModal()"
                    style="margin-top:10px;">
                    <span class="icon">🔗</span>
                    <span class="text">匯入鏈上數據</span>
                </button>
            </div>

            <div class="panel-card admin-section">
                <h3>🛠️ 獎池調整</h3>
                <div class="pool-adjust-controls">
                    <input type="number" id="adminPoolInput" placeholder="數額" step="1000">
                    <button class="btn-icon" onclick="game.adjustPool(1)">➕</button>
                    <button class="btn-icon warn" onclick="game.adjustPool(-1)">➖</button>
                </div>
            </div>

            <div class="panel-card queue-section">
                <div class="section-header">
                    <h3>⏳ 排隊列表 (<span id="queueCount">0</span>)</h3>
                    <button id="btnClearQueue" class="btn-text" onclick="game.clearQueue()"
                        style="display:none;">清除</button>
                </div>
                <div class="queue-list" id="queueList">
                    <div class="empty-state">目前沒有玩家排隊</div>
                </div>
            </div>

            <div class="panel-card rules-section">
                <h3>📜 遊戲規則</h3>
                <ul class="rules-list">
                    <li class="rule-item hit">
                        <span class="rule-icon">🔥</span>
                        <div class="rule-content">
                            <span class="rule-name">撞柱 (射中門柱)</span>
                            <span class="rule-val">賠付 x2 (輸2倍)</span>
                        </div>
                    </li>
                    <li class="rule-item hit">
                        <span class="rule-icon">💥</span>
                        <div class="rule-content">
                            <span class="rule-name">三條 (全部相同)</span>
                            <span class="rule-val">賠付 x3 (輸3倍)</span>
                        </div>
                    </li>
                    <li class="rule-item win">
                        <span class="rule-icon">⚽</span>
                        <div class="rule-content">
                            <span class="rule-name">進球 (範圍內)</span>
                            <span class="rule-val nice">贏取獎金 (賠率計算)</span>
                        </div>
                    </li>
                    <li class="rule-item lose">
                        <span class="rule-icon">❌</span>
                        <div class="rule-content">
                            <span class="rule-name">射歪 (範圍外)</span>
                            <span class="rule-val">全輸 (加入獎池)</span>
                        </div>
                    </li>
                </ul>
                <div class="rule-note">
                    * 最低注額: 10,000 NESO<br>
                </div>
            </div>
        </aside>
    </div>

    <!-- Add Player Modal -->
    <dialog id="addPlayerModal" class="cyber-modal">
        <div class="modal-wrapper">
            <h3>新增挑戰者</h3>
            <div class="modal-body">
                <div class="input-group">
                    <label>錢包地址</label>
                    <input type="text" id="modalInputAddress" placeholder="0x..." autocomplete="off">
                </div>
                <div class="input-group">
                    <label>下注金額 (最低 10000)</label>
                    <input type="number" id="modalInputAmount" placeholder="10000" autocomplete="off" min="10000"
                        step="100">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="ui.closeAddModal()">取消</button>
                <button class="btn-confirm" onclick="game.manualAddFromModal()">確認新增</button>
            </div>
        </div>
    </dialog>

    <!-- Replay Modal -->
    <dialog id="replayModal" class="cyber-modal">
        <div class="modal-wrapper">
            <h3>🔄 再來一局</h3>
            <div class="modal-body">
                <p style="margin-bottom:15px; color:#ccc;">玩家: <span id="replayPlayerAddress"
                        style="color:var(--primary)"></span></p>
                <div class="input-group">
                    <label>下注金額</label>
                    <input type="number" id="replayInputAmount" placeholder="金額" autocomplete="off" min="10000"
                        step="100">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="ui.closeReplayModal()">取消</button>
                <button class="btn-confirm" onclick="game.confirmReplay()">確認下注</button>
            </div>
        </div>
    </dialog>

    <!-- Import Modal -->
    <dialog id="importModal" class="cyber-modal">
        <div class="modal-wrapper big-modal">
            <h3>🔗 鏈上匯入 (Henesys)</h3>
            <div class="modal-body">
                <div class="input-group">
                    <label>監聽錢包地址 (你的收款地址)</label>
                    <input type="text" id="importWalletAddr" placeholder="0x..."
                        onchange="localStorage.setItem('hostWallet', this.value)">
                </div>
                <div class="scan-controls">
                    <button class="btn-action-small" onclick="game.scanChain()">🔍 掃描最近 1000 區塊</button>
                    <span id="scanStatus" class="status-text"></span>
                </div>
                <div class="scan-results">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th width="50">選取</th>
                                <th>玩家地址</th>
                                <th>金額</th>
                                <th>時間(預估)</th>
                            </tr>
                        </thead>
                        <tbody id="importList">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="ui.closeImportModal()">關閉</button>
                <button class="btn-confirm" onclick="game.importSelected()">匯入選取項目</button>
            </div>
        </div>
    </dialog>

    <!-- Payout Modal -->
    <dialog id="payoutModal" class="cyber-modal">
        <div class="modal-wrapper">
            <h3 class="win-title">🎉 恭喜中獎! 🎉</h3>
            <div class="payout-info">
                <div class="winner-row">
                    <span class="label">中獎者:</span>
                    <span id="payoutAddress" class="val-mono"></span>
                </div>
                <div class="amount-row">
                    <span class="label">應付金額:</span>
                    <span id="payoutShowAmount" class="val-gold"></span>
                    <span class="unit">NESO</span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-confirm large" onclick="ui.copyWinnerAddress()">📋 複製地址與金額</button>
                <p class="copy-hint" id="copyHint">已複製! 準備轉帳。</p>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="ui.closeModal()">關閉</button>
            </div>
        </div>
    </dialog>

    <script src="game.js"></script>
    <script src="ui.js"></script>
</body>

</html>